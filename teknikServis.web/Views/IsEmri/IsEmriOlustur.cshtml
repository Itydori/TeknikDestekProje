@using TeknikServis.Entities.Enums
@model TeknikServis.Web.Models.IsEmriOlusturViewModel

@{
	Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container mt-4">
	<div class="card shadow-sm mb-4">
		<div class="card-header bg-warning text-black d-flex justify-content-between align-items-center">
			<h4 class="mb-0"><i class="fas fa-list mr-2"></i> Açık İş Emirleri (@Model.AcikIsEmirleri.Count())</h4>
		</div>
		<div class="card-body">
			@if (!Model.AcikIsEmirleri.Any())
			{
				<span class="text-danger fw-bold">Müşterinin açık iş emri yok</span>
			}
			else
			{
				<table class="table table-striped table-hover">
					<thead class="table-dark">
						<tr>
							<th>Müşteri Adı</th>
							<th>Marka</th>
							<th>Model</th>
							<th>Arıza Durumu</th>
							<th>Model Yılı</th>
							<th>Garanti</th>
							<th>Talep</th>
							<th>Geliş Tarihi</th>
							<th>Fiş No</th>
							<th>İşlemler</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var item in Model.AcikIsEmirleri)
						{
							<tr>
								<td>@item.Musteri.Ad</td>
								<td>@item.Marka</td>
								<td>@item.Model</td>
								<td>@item.ArizaDurumu</td>
								<td>@item.Yil</td>
								<td>@Enum.GetName(typeof(GarantiDurumuEnum), item.GarantiDurumu)</td>
								<td>@Enum.GetName(typeof(ServisTalebiEnum), item.ServisTalebi)</td>
								<td>@item.GelisTarih:dd.MM.yyyy</td>
								<td>@item.FisNo</td>
								<td>
									<a asp-action="IslemYap" asp-route-isEmriTeslimId="@item.IsEmriTeslimId" class="btn btn-primary btn-sm">
										<i class="fas fa-edit"></i> Düzenle
									</a>
									<button class="btn btn-danger btn-sm" onclick="sil(@item.IsEmriTeslimId)">
										<i class="fas fa-trash"></i>
									</button>
								</td>
							</tr>
						}
					</tbody>
				</table>
			}
		</div>
	</div>

	<!-- Yeni İş Emri Formu -->
	@using (Html.BeginForm("IsEmriKaydet", "IsEmri", FormMethod.Post, new { id = "serviceOrderForm" }))
	{
		@Html.HiddenFor(m => m.NewIsEmri.MusteriId)

		<div class="container mt-4">
			<div class="card shadow-sm">
				<div class="card-header bg-primary text-white">
					<h4 class="mb-0"><i class="fas fa-tools mr-2"></i> İş Emri Oluşturma</h4>
				</div>
				<div class="card-body">

					<div class="row mb-4">
						<div class="col-md-6 mb-3">
							<label asp-for="NewIsEmri.Marka" class="form-label fw-bold"></label>
							<input asp-for="NewIsEmri.Marka" list="markalar" class="form-control" placeholder="Marka seç veya yaz" />
							<datalist id="markalar">
								<option value="Apple"></option>
								<option value="Samsung"></option>
								<option value="Huawei"></option>
								<option value="Xiaomi"></option>
								<option value="Oppo"></option>
								<option value="Vestel"></option>
								<option value="Asus"></option>
								<option value="Casper"></option>
								<option value="Lenovo"></option>
								<option value="HP"></option>
								<option value="Dell"></option>
								<option value="Monster"></option>
								<option value="MSI"></option>
								<option value="Acer"></option>
								<option value="Sony"></option>
								<option value="LG"></option>
								<option value="Philips"></option>
								<option value="Beko"></option>
								<option value="Arçelik"></option>
								<option value="Regal"></option>
								<option value="Bosch"></option>
								<option value="Siemens"></option>
								<option value="Electrolux"></option>
								<option value="Profilo"></option>
							</datalist>
							<span asp-validation-for="NewIsEmri.Marka" class="text-danger"></span>
						</div>

						<div class="col-md-6 mb-3">
							<label asp-for="NewIsEmri.Model" class="form-label fw-bold"></label>
							<input asp-for="NewIsEmri.Model" class="form-control" placeholder="Model" />
							<span asp-validation-for="NewIsEmri.Model" class="text-danger"></span>
						</div>
					</div>

					<div class="row mb-4">
						<div class="col-md-6 mb-3">
							<label asp-for="NewIsEmri.ArizaDurumu" class="form-label fw-bold"></label>
							<input asp-for="NewIsEmri.ArizaDurumu" class="form-control" placeholder="Ürün Arızası" />
							<span asp-validation-for="NewIsEmri.ArizaDurumu" class="text-danger"></span>
						</div>

						<div class="col-md-6 mb-3">
							<label asp-for="NewIsEmri.Yil" class="form-label fw-bold"></label>
							<select asp-for="NewIsEmri.Yil" class="form-select">
								@for (int i = DateTime.Now.Year; i >= DateTime.Now.Year - 10; i--)
								{
									<option value="@i">@i</option>
								}
							</select>
							<span asp-validation-for="NewIsEmri.Yil" class="text-danger"></span>
						</div>
					</div>

					<div class="row mb-4">
						<div class="col-md-6 mb-3">
							<label asp-for="NewIsEmri.GarantiDurumu" class="form-label fw-bold"></label>
							<select asp-for="NewIsEmri.GarantiDurumu" class="form-select">
								<option value="1">Garantili</option>
								<option value="2">Garantisiz</option>
							</select>
							<span asp-validation-for="NewIsEmri.GarantiDurumu" class="text-danger"></span>
						</div>

						<div class="col-md-6 mb-3">
							<label asp-for="NewIsEmri.ServisTalebi" class="form-label fw-bold"></label>
							<select asp-for="NewIsEmri.ServisTalebi" class="form-select">
								<option value="1">Arızalı Ürün</option>
								<option value="2">Yedek Parça Sipariş</option>
							</select>
							<span asp-validation-for="NewIsEmri.ServisTalebi" class="text-danger"></span>
						</div>
					</div>

					<div class="row mb-4">
						<div class="col-md-6 mb-3">
							<label asp-for="NewIsEmri.GelisTarih" class="form-label fw-bold"></label>
							<input asp-for="NewIsEmri.GelisTarih" type="date" class="form-control" />
							<span asp-validation-for="NewIsEmri.GelisTarih" class="text-danger"></span>
						</div>

						@*<div class="col-md-6 mb-3">
							<label asp-for="NewIsEmri.FisNo" class="form-label fw-bold"></label>
							<input asp-for="NewIsEmri.FisNo" class="form-control" placeholder="Fiş No" />
							<span asp-validation-for="NewIsEmri.FisNo" class="text-danger"></span>
						</div>*@
					</div>

					<div class="d-flex justify-content-end mt-4">
						<button type="submit" class="btn btn-success">
							<i class="fas fa-save me-1"></i> İş Emri Oluştur
						</button>
					</div>

				</div>
			</div>
		</div>
	}

	@section Scripts {
		@{
			await Html.RenderPartialAsync("_ValidationScriptsPartial");
		}
	}
	<!-- Kapalı İş Emirleri -->
	<div class="card shadow-sm">
		<div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
			<h4 class="mb-0"><i class="fas fa-archive mr-2"></i> Kapalı İş Emirleri (@Model.KapaliIsEmirleri.Count())</h4>
		</div>
		<div class="card-body">
			@if (!Model.KapaliIsEmirleri.Any())
			{
				<span class="text-danger fw-bold">Müşterinin kapalı iş emri yok</span>
			}
			else
			{
				<table class="table table-striped table-hover">
					<thead class="table-dark">
						<tr>
							<th>Müşteri Adı</th>
							<th>Marka</th>
							<th>Model</th>
							<th>Arıza</th>
							<th>Yıl</th>
							<th>Garanti</th>
							<th>Talep</th>
							<th>Geliş</th>
							<th>Fiş No</th>
							<th>PDF</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var item in Model.KapaliIsEmirleri)
						{
							<tr>
								<td>@item.Musteri.Ad</td>
								<td>@item.Marka</td>
								<td>@item.Model</td>
								<td>@item.ArizaDurumu</td>
								<td>@item.Yil</td>
								<td>@Enum.GetName(typeof(GarantiDurumuEnum), item.GarantiDurumu)</td>
								<td>@Enum.GetName(typeof(ServisTalebiEnum), item.ServisTalebi)</td>
								<td>@item.GelisTarih:dd.MM.yyyy</td>
								<td>@item.FisNo</td>
								<td>
									<a asp-controller="Fatura" asp-action="FaturaYazdir" asp-route-id="@item.IsEmriTeslimId" class="btn btn-danger btn-sm" target="_blank">
										<i class="fas fa-file-pdf"></i>
									</a>
								</td>
							</tr>
						}
					</tbody>
				</table>
			}
		</div>
	</div>
</div>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		var form = document.getElementById("serviceOrderForm");
		if (form) {
			form.addEventListener("submit", function (event) {
				if (!form.checkValidity()) {
					event.preventDefault();
					event.stopPropagation();
				}
				form.classList.add("was-validated");
			}, false);
		}
	});

	function sil(id) {
		if (confirm("Silmek istediğinize emin misiniz?")) {
			fetch('/IsEmri/IsEmriSil', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
				},
				body: JSON.stringify({ id: id })
			}).then(res => {
				if (res.ok) location.reload();
				else alert("Silme işlemi başarısız oldu.");
			});
		}
	}
</script>

